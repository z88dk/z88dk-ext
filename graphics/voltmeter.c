
// Voltmeter
//===========
//
// By Stefano Bodrato, 13/10/2025
//
// This program requires an interface built around the ADC0808/ADC0809 interface
// such as the LX.746 board published in Nuova Elettronica n.107, Apr. 1986
//
// IN/OUT communication is hardcoded for port #1, but it can be easily adjusted
// by changing "inp(1)" and "outp(1,ch)" with a different port number.
// (e.g. Change to 31 for the Mageco Electronic "8 Entrees Analogiques ZX" card)
//


#include <graphics.h>
#include <conio.h>
#include <games.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <lib3d.h>

int i,a,a2,b,c=0;
int d;
int x,y;
int sz;
int cx,cy,r;
int ch=0;
char k;
char msg[20];

char voltmeter_pic[] = { 70, 52, 
  0x1F , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xC0 , 0x70 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x70 , 0xC0 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x00 , 0x1C , 0x80 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x0C , 0x8F , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF 
, 0x8C , 0x88 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x8C , 0x88 
, 0x00 , 0x00 , 0x00 , 0xF0 , 0x00 , 0x04 , 0x44 , 0x8C , 0x88 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x02 , 0xA8 , 0x8C , 0x88 , 0x00 , 0x0F , 0x00 , 0x00 
, 0x03 , 0xC1 , 0x10 , 0x8C , 0x88 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x8C , 0x88 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x8C 
, 0x88 , 0x03 , 0xC1 , 0x05 , 0xFB , 0x18 , 0x0F , 0x00 , 0x8C , 0x88 , 0x03 
, 0x00 , 0x89 , 0x0A , 0xA8 , 0x00 , 0x00 , 0x8C , 0x88 , 0x00 , 0xC0 , 0x51 
, 0x0A , 0x48 , 0x00 , 0x00 , 0x8C , 0x88 , 0x00 , 0x30 , 0x21 , 0xFA , 0x08 
, 0x00 , 0x00 , 0x8C , 0x88 , 0x00 , 0x0C , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x8C , 0x88 , 0x78 , 0x03 , 0x00 , 0x00 , 0x00 , 0x00 , 0xF0 , 0x8C , 0x88 
, 0x00 , 0x00 , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00 , 0x8C , 0x88 , 0x00 , 0x00 
, 0x30 , 0xE0 , 0x00 , 0x00 , 0x00 , 0x8C , 0x88 , 0x00 , 0x00 , 0x0D , 0x10 
, 0x24 , 0x90 , 0x00 , 0x8C , 0x88 , 0x00 , 0x00 , 0x02 , 0xE8 , 0x00 , 0x00 
, 0x00 , 0x8C , 0x88 , 0xF0 , 0x00 , 0x04 , 0xA4 , 0x00 , 0x00 , 0x78 , 0x8C 
, 0x8F , 0xFF , 0xFF , 0xFC , 0xE7 , 0xFF , 0xFF , 0xFF , 0x8C , 0x80 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x0C , 0x83 , 0xE7 , 0x80 , 0x00 
, 0x00 , 0x0A , 0x5C , 0xA0 , 0x0C , 0x80 , 0x66 , 0x00 , 0x00 , 0x00 , 0x04 
, 0x54 , 0xC0 , 0x0C , 0x81 , 0x81 , 0x80 , 0x0F , 0xFF , 0x0A , 0x5C , 0xA0 
, 0x0C , 0x82 , 0x00 , 0x80 , 0x78 , 0x01 , 0xE0 , 0x00 , 0x00 , 0x0C , 0x83 
, 0xEB , 0x83 , 0xC0 , 0x00 , 0x3C , 0x0A , 0x4A , 0x0C , 0x80 , 0x00 , 0x0C 
, 0x00 , 0x00 , 0x03 , 0x04 , 0x4C , 0x0C , 0x80 , 0x00 , 0x10 , 0x00 , 0x00 
, 0x00 , 0x8A , 0x4A , 0x0C , 0x84 , 0xF8 , 0x20 , 0x00 , 0x00 , 0x00 , 0x40 
, 0x00 , 0x0C , 0x84 , 0x88 , 0x60 , 0x00 , 0x00 , 0x00 , 0x60 , 0x00 , 0x0C 
, 0x84 , 0x88 , 0xC0 , 0xFF , 0xFF , 0x00 , 0x32 , 0x97 , 0x7C , 0x84 , 0x88 
, 0x87 , 0x88 , 0x89 , 0xC0 , 0x11 , 0x15 , 0x5C , 0x84 , 0xF8 , 0x81 , 0xD1 
, 0x11 , 0x20 , 0x12 , 0x97 , 0x7C , 0x80 , 0x00 , 0x80 , 0x7A , 0x22 , 0x30 
, 0x10 , 0x00 , 0x0C , 0x80 , 0x00 , 0x80 , 0x0C , 0x44 , 0x58 , 0x10 , 0x00 
, 0x0C , 0x93 , 0xDE , 0x80 , 0x03 , 0x88 , 0xB8 , 0x10 , 0x00 , 0x0C , 0x92 
, 0x52 , 0x80 , 0x00 , 0xFD , 0x70 , 0x12 , 0x97 , 0x0C , 0x92 , 0x52 , 0xC0 
, 0x00 , 0x0F , 0xC0 , 0x31 , 0x15 , 0x0C , 0x92 , 0x52 , 0x60 , 0x00 , 0x00 
, 0x00 , 0x62 , 0x97 , 0x0C , 0x93 , 0xDE , 0x20 , 0x00 , 0x00 , 0x00 , 0x40 
, 0x00 , 0x0C , 0x80 , 0x00 , 0x10 , 0x00 , 0x00 , 0x00 , 0x80 , 0x00 , 0x0C 
, 0x93 , 0xDE , 0xFC , 0x00 , 0x00 , 0x03 , 0x00 , 0x03 , 0xCC , 0x92 , 0x52 
, 0x93 , 0xC0 , 0x00 , 0x3C , 0x52 , 0x03 , 0xCC , 0x92 , 0x52 , 0x90 , 0x78 
, 0x01 , 0xE0 , 0x22 , 0x00 , 0x0C , 0x92 , 0x52 , 0x90 , 0x0F , 0xFF , 0x00 
, 0x52 , 0x03 , 0xCC , 0x93 , 0xDE , 0xF0 , 0x00 , 0x00 , 0x00 , 0x00 , 0x03 
, 0xCC , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x1C , 0xFF 
, 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xFC , 0x7F , 0xFF , 0xFF 
, 0xFF , 0xFF , 0xFF , 0xFF , 0xFF , 0xF8  };



char friendly[] = { 88, 50,
  0x00 , 0x00 , 0x07 , 0xFF , 0xF0 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x3F , 0xFC , 0xE0 , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0xF8 , 0x18 , 0x35 , 0x44 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x01 , 0xFF , 0xE0 , 0x18 , 0x02 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x03 , 0xFF , 0x1F , 0xFC , 0x93 , 0xE0 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x24 , 0x04 , 0x00 , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0xC2 , 0x3E , 0x54 , 0x61 , 0x80 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x03 , 0x81 , 0x1E , 0x00 , 0x70 , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x07 , 0xFC , 0x00 , 0x8F , 0x2D , 0x38 , 0x60 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x38 , 0x00 , 0x00 , 0x47 , 0xFF , 0xFC , 0x30 , 0x00 , 0x00 , 0x00 , 0x00 
, 0xE0 , 0x00 , 0x00 , 0x26 , 0x00 , 0x02 , 0x18 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x80 , 0x00 , 0x00 , 0x13 , 0xFF , 0xFF , 0x0C , 0x00 , 0x00 , 0x00 , 0x00 
, 0x80 , 0x00 , 0x00 , 0x10 , 0x00 , 0x00 , 0x06 , 0x00 , 0x00 , 0x00 , 0x00 
, 0xC0 , 0x00 , 0x00 , 0x10 , 0x00 , 0x00 , 0x03 , 0x00 , 0x00 , 0x00 , 0x00 
, 0xC0 , 0x00 , 0x00 , 0x20 , 0x00 , 0x00 , 0x01 , 0x00 , 0x00 , 0x07 , 0xE0 
, 0x40 , 0x00 , 0x00 , 0x20 , 0xF8 , 0x78 , 0x03 , 0x00 , 0x00 , 0x1C , 0x10 
, 0x20 , 0x00 , 0x00 , 0x41 , 0xCD , 0xC4 , 0x02 , 0x00 , 0x00 , 0xF0 , 0x60 
, 0x30 , 0x00 , 0x00 , 0x43 , 0x05 , 0x02 , 0x04 , 0x00 , 0x07 , 0x21 , 0xFE 
, 0x18 , 0x00 , 0x00 , 0x46 , 0x1F , 0x0E , 0x04 , 0x00 , 0xFD , 0x30 , 0x03 
, 0x08 , 0x00 , 0x00 , 0x84 , 0x3E , 0x1E , 0x0C , 0x07 , 0x83 , 0x30 , 0x01 
, 0x0C , 0x00 , 0x00 , 0x84 , 0x3F , 0x1E , 0x08 , 0x3C , 0x3F , 0xFC , 0x01 
, 0x04 , 0x00 , 0x00 , 0x86 , 0x19 , 0x8C , 0x08 , 0xE0 , 0xF0 , 0x06 , 0x07 
, 0x06 , 0x00 , 0x00 , 0x83 , 0xF0 , 0xF8 , 0x0B , 0x87 , 0x80 , 0x03 , 0x3C 
, 0x03 , 0x00 , 0x00 , 0x80 , 0x00 , 0x00 , 0x0E , 0x3C , 0x00 , 0x01 , 0xE0 
, 0x01 , 0x00 , 0x00 , 0x80 , 0x00 , 0x00 , 0x0D , 0xE0 , 0x00 , 0x00 , 0x00 
, 0x01 , 0x8F , 0x80 , 0x80 , 0x00 , 0x00 , 0x0F , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0xF8 , 0xC0 , 0x9F , 0x3E , 0xF9 , 0xEE , 0x00 , 0x00 , 0x00 , 0x00 
, 0x03 , 0x87 , 0x80 , 0x91 , 0x22 , 0x89 , 0x28 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x1E , 0x3C , 0x00 , 0x9F , 0x3E , 0xF9 , 0x28 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x70 , 0xE0 , 0x60 , 0x80 , 0x00 , 0x01 , 0x28 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x30 , 0x8C , 0xD8 , 0x9F , 0x3E , 0xF9 , 0x28 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x18 , 0xEB , 0x88 , 0x91 , 0xA2 , 0x89 , 0x28 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x0C , 0x3D , 0x18 , 0x9F , 0x3E , 0xF9 , 0xE8 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x06 , 0x68 , 0x30 , 0x80 , 0x00 , 0x00 , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x03 , 0xFE , 0x60 , 0x8F , 0xFF , 0xFF , 0x88 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x07 , 0x80 , 0x87 , 0xFF , 0xFF , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x03 , 0x00 , 0x83 , 0xFF , 0xFE , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x01 , 0x00 , 0x80 , 0x00 , 0x00 , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x01 , 0x83 , 0xFF , 0xFF , 0xFF , 0xF8 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0xC6 , 0x00 , 0x00 , 0x00 , 0x20 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0xDC , 0x03 , 0x80 , 0x38 , 0xC0 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x7F , 0xFE , 0x40 , 0x4B , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x02 , 0x3F , 0xCC , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x06 , 0x60 , 0x48 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x1C , 0xC0 , 0x68 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x2C , 0x7F , 0x9F , 0xF0 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x43 , 0xE1 , 0x20 , 0x08 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x80 , 0x00 , 0xA0 , 0x10 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x60 , 0x00 , 0xFF , 0xE0 , 0x00 , 0x00 , 0x00 , 0x00 
, 0x00 , 0x00 , 0x00 , 0x3F , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 
 };



void tiny (int x, int y, char* text) {
	int pos;
	int len=strlen(text);
	for (pos=0; pos <len; pos++) {
		x_4x6=x+(pos*4);
		y_4x6=y;
		putc4x6(text[pos]);
	}
}




void main() {
	
	
	cx=getmaxx()/2;	cy=40+getmaxy()/2;
	fputc_cons(12);
	
	putsprite (spr_or,160,7,&voltmeter_pic);
	putsprite (spr_or,5,130,&friendly);
	
	printf ("Precision:\n\n\n            [A] 2.5 Volt\n\n            [B] 5 Volt\n\n            [C] 50 Volt\n\n            [D] 100 Volt");
	k=getk();
	while ((k<'a') || (k>'d')) k=getk();
	if (k=='a') c=1;   // Raise precision
	d=1;
	if (k=='c') d=10;   // Enable tenth division
	if (k=='d') d=20;   // Divide results by 20

	fputc_cons(12);

	//clg();
	
	drawb (12,20,230,120);
	drawb (10,22,230,120);
	drawb (38,149,176,37);
	circle(cx,cy,5,1);
	circle(cx,cy,3,1);


	for (ch=0; ch<8; ch++) {
		if (ch<4)
			gotoxy(12,19+ch);
		else
			gotoxy(39,19+(ch-4));

		printf ("[%u] -.------",ch);
	}
	
	ch=0;

	//tiny (40,10,"Tiny text 1234567890");

	r=getmaxy()/2;

	for (i=0;i<=128;i+=8) {
		a =334-i;
		draw(cx+icos(a)*r/250,cy+isin(a)*r/250,cx+icos(a)*r/244,cy+isin(a)*r/244);
	}

	for (i=0;i<=128;i+=32) {
		a =334-i;
		draw(cx+icos(a)*r/250,cy+isin(a)*r/250,cx+icos(a)*r/230,cy+isin(a)*r/230);
		if (c)
			sprintf (msg,"%.2f",2.5*(128-i)/128.0);
		else
			sprintf (msg,"%.2f",5.0*d*(128-i)/128.0);

		tiny (cx+icos(a)*r/212-10,cy+isin(a)*r/220,msg);
	}

	gotoxy(6,1);
	puts ("Channel: 0  -  Press 'P' to read the current value");

// Loop infinito
while(1) {
	outp(1,ch);
	undraw(cx,cy,cx+icos(a2)*r/256,cy+isin(a2)*r/256);
	a2=a;
	b=inp(1);
	if (c) {
		a=334-((127-(b>127?127:b))/2);
	} else
		a=334-((255-b)/2);

	draw(cx,cy,cx+icos(a)*r/256,cy+isin(a)*r/256);
	circle(cx,cy,5,1);
	circle(cx,cy,3,1);
	k=getk();
	if ((k>='0') && (k<='7')) {
		ch=k-'0';
		gotoxy(15,1);
		fputc_cons(k);
	}
	if (k=='p') {
		if (ch<4)
			gotoxy(12,19+ch);
		else
			gotoxy(39,19+(ch-4));

		if (c)
			printf ("[%u] %f",ch,2.5*b/255.0);
		else
			printf ("[%u] %f",ch,5.0*d*b/255.0);
		while (getk()=='p') {};
		while (getk()!='p') {};
	}
	if (k=='q') exit(0);
}

}
